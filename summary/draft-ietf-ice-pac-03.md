> Read [original](https://tools.ietf.org/html/draft-ietf-ice-pac-03) / [markdown](../markdown/draft-ietf-ice-pac-03.md)

---

# ICE Patiently Awaiting Connectivity

## 1. Introduction

- ICEというプロトコルでUDPベースのやり取りを開始できる
  - RFC8445参照
- ICEでは、エンドポイントが互いに候補を出してペアを作る
  - そしてそのペアで疎通を確認する
  - もし全て失敗したら、ICEが失敗したといえる
- この疎通確認の過程で、副産物として新たな候補が見つかることがある
  - `prflx`な候補と呼ばれる
- ただこの場合でも、候補ペアの確認を終えて全て失敗していたら、ICEは失敗となる
  - `prflex`の候補をリストに加える前に、全行程が終了してしまう
- この文書は、これを回避したいための仕様
  - とはいってもICEの状態を`failed`にする前に、少し待機するだけ

## 2. Conventions

- いつもの

## 3. Relevant Scenarios

- ICEの失敗条件
  - リモート・ローカルで候補の収集が終わっていて
  - 有効なペアがなく、これ以上チェックすべき候補もない場合
- `prflx`な候補を見つけるまでの猶予がないのが問題
- だいたいのICEのユースケースなら、10秒も待てばOK

### 3.1. No Candidates From Peer

- そもそも候補が0件の場合
  - ICEの仕様としては問題ないケース
- 候補がなくとも疎通できるとわかっている場合は不要なので
- ただし、RFC8445に準拠すると、即`failed`になるけど

### 3.2. All Candidates Discarded

- 全ての候補が捨てられる場合
  - IPv6非対応なエンドポイントで、IPv6の候補が見つかったときなど
- これもおなじく`failed`になる

### 3.3. Immediate Candidate Pair Failure

- いくつかの状況で、ペアが`failed`扱いにされることがある
  - RFC8445のSection 7.2.5.2を参照
- その場合もICEはうまくいかない

## 4. Update to RFC 8445

- これらを踏まえて、`prflx`な候補のために待ち時間を設けたい
- ICE-Fullのエンドポイントは、`PAC`タイマーをセットすることとする
- タイマーはICEの疎通確認をはじめるときにスタートする
   - 実際にSTUNを送信・受信するタイミングではない
   - その準備ができたタイミング
- タイマーの値のおすすめは、トランザクションのタイムアウト値と同じ
  - `prflx`が返ってくるなら、その時間内に返ってくるから
- このタイマーが有効な間、チェックリストの状態を`failed`にしてはいけない
- RFC8445では、従来通りにペアを見つけてノミネートするまでの時間に制約はなかった
  - ただし`prflx`がベストな経路であるならば、それを使うべきである
  - なのでノミネートする前に、このタイマーの間は待機するべき
- ノミネートは今まで通り`CONTROLLING`なエンドポイントが行う
  - もしかしたら、独自の判断で、タイマーを待たずにノミネートするかもしれない

## 5. Update to RFC XXXX

- そのほかの関連仕様への影響
  - draft-ietf-ice-trickle
- `failed`に移行する前に新たな候補が提示されるかもしれない
- なので`end-of-candidates`がわかるまで待機すると書かれている
- TrickleICEでも、ここで触れる内容は当てはまる
- `end-of-candidates`を通知することは推奨であり必須要件ではないことに注意
  - なのでこの通知なしに、全ての候補を受信したというタイミングを決めてる実装があるかも
- この`PAC`タイマーでもって、そのタイミングを決めることもできるだろう

## 6. Security Considerations

- RFC8445の内容に準ずる

## 7. IANA considerations

- IANAは関係ない
