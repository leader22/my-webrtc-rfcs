> Read [original](https://tools.ietf.org/html/rfc3264) / [markdown](../markdown/rfc3264.md)

---

# An Offer/Answer Model with the Session Description Protocol (SDP)

## 1 Introduction

- もともとSDPはマルチキャストのために生まれた
  - SAP(Session Announcement Protocol)とあわせて使う
- しかしユニキャストだと、参加者の環境の要件の最小公倍数が必要
- オファーとアンサーに概念を分けることでこれに対応したい
- そのSDPをどう伝えるか = シグナリングは規定しない

## 2 Terminology

- いつもの

## 3 Definitions

- 単語の定義

## 4 Protocol Operation

- オファーを何らかの経路で送る
- それは受け取られるかもしれないし、拒否されるかもしれない
  - 拒否されるとなかったことになる
- 一度オファーを受け取ったら、その側はオファーを発行してはいけない
- 受取も拒否もされてないなら、新しいオファーを発行してはいけない
- オファーを出していながらオファーを受け取っりする状態をグレアという
  - こうならないようにするのもシグナリングプロトコルの債務
    - たとえばSIP

## 5 Generating the Initial Offer

- RFC2327では`e=`行と`p=`行が必要だったが不要にする
- `o=`行: セッションのID、バージョンなど
  - SDPとしては複数のセッションを記述できる
  - けどここでは単一のセッションのみに限定
- `s=`行: セッションのタイトル
  - 特にない場合は`-` OR 空白文字`0x20`のどちらかがおすすめ
- `t=`行: セッションの時間
  - 外部でシグナリングする場合は`0 0`
- `m=`セクション: 0個以上のメディアストリーム
  - `m=`行からはじまる
  - `a=`行: 属性を表すのに使う
- マルチキャストかユニキャストかによって、`m=`セクションの構成が変わる

## 5.1 Unicast Streams

- ストリームはそもそも双方向の土管
  - 送信専用の場合は、`a=sendonly`
  - 受信専用の場合は、`a=recvonly`
  - どっちもしない場合は、`a=inactive`
  - デフォルトの場合は、`a=sendrecv`で省略可能
- オファーに書いてあるアドレスとポートに対してRTPが送られる
  - RTCPは明示されない限り`そのポート + 1`に送られる
  - ポートが`0`の場合は、そのメディアは使わないという意味
    - 最初のオファーにおいては無意味な指定
    - ただSDPの仕様としては、アンサーで使うために説明してる
- RTPならRTPのペイロードタイプが記載される
  - `a=rtpmap`
  - 複数記載することで、どれかが使えるという意味になる
  - セッションの途中で変えることもできる
  - `a=fmtp`で細かいパラメータを指定する
- `m=`行のフォーマットは優先度順
- `a=ptime`: パケットの間隔は`0`より大きい値
- ストリームは複数あることもある
  - それぞれエンコーディングが違ってもよい
  - 複数受け取ったら、全て表示する必要がある
  - 表示する出口が1つの場合、何らかの形で1つにする必要がある
  - 送信元が同じであれば、送信前に結合されている必要がある
- プリペイドのテレホンカードのアプリが典型例

## 5.2 Multicast Streams

- `recvonly`か`sendonly`なストリームが含まれる場合
- 誰かしらがそれを望んでいるということ

## 6 Generating the Answer

- オファーとアンサーは別の参加者によって作られる
  - `o=`行は異なるし無関係
- オファーの`m=`セクションとアンサーの`m=`セクションの数は同じである必要がある
- `t=`行は一致している必要がある
- なんらかの理由でオファーを拒否することもある
  - その場合は当然メディアを送ってはいけない
  - `m=`行のポートを`0`にする

## 6.1 Unicast Streams

- オファーに`sendonly`とある場合は、`recvonly`か`inactive`でアンサーする
- `sendrecv`がきたら、`sendonly`か`recvonly`か`sendrecv`か`inactive`
- アンサーで`recvonly`を返す場合は、メディアフォーマットを1つ以上含める
  - もちろん追加のフォーマットを提示してもいい
- `sendonly`を返す場合は、オファーにあるメディアフォーマットで
- `m=`行のメディアフォーマットは、対応しているものをアンサーする
  - 対応していないものは省略される
- そのほかはオファー時と同じ
  - 拒否したいストリームにはポートを`0`にする
- アンサーを送ったら、その内容に備える必要がある
  - = メディアの受取に備えるということ

## 6.2 Multicast Streams

- マルチキャストの場合
- アンサーは複数の参加者の間でも一致しないといけない
- サポートしてないフォーマットは、それを削除することで示す

## 7 Offerer Processing of the Answer

- アンサーが届いたらメディアを送信してもよい
  - アンサーにあるフォーマットの最優先のもので
- ただしこれはMUSTではなくSHOULD
  - 別のシグナリング方法でその旨が伝えられるかもしれないので

## 8 Modifying the Session

- セッションの途中で新たなオファーを発行してもよい
  - また同じ手順でオファー・アンサーするだけ
- その場合は、`o=`行にあるバージョンを `+1`する
  - そのほかは同じでよい
- `m=`行は減らしてはいけない
  - 増えることはある
  - ただし`a=`行はなくてもよい

## 8.1 Adding a Media Stream

- メディアを追加する場合
  - 新しい`m=`セクションを追加する
  - OR ポートが`0`だったセクションを使う
- ここを見ることで、メディアの追加をアンサー側が知ることができる

## 8.2 Removing a Media Stream

- メティアを削除する場合
  - ポート番号を`0`にする
- その場合、`a=`行を省略してもいい
- 削除したストリームに対してはもちろんメディアを送信してはいけない
  - これによってリソースの開放ができる

## 8.3 Modifying a Media Stream

- メディアの特徴も変更できる

## 8.3.1 Modifying Address, Port or Transport

- ポートの変更
  - `m=`行の該当部分を書き換えて送る
  - その他の指定は変えないほうがよい
- 移行完了するまで、古いポートへの送信をやめないほうがよい
  - 受信側も、古いポートに溜まっているパケットを全て再生してから新しいものを
- アドレスの変更も基本的にはポートと同じ
  - ただし回線が変わるだろう

## 8.3.2 Changing the Set of Media Formats

- メディアのフォーマットセットの変更
  - `m=`行の該当部分を書き換えて送る
  - ただしRTPでは動的なペイロードタイプの番号はセッション中に変えられない
- 以前存在していたフォーマットが消えたなら、それはもう使ってはいけない
  - 以前は使っていたとしても使ってはいけない
- どうやってフォーマットの変更完了を検知するか
  - ポートも変更してしまう
  - 新しいペイロードタイプにする
  - タイマーを使う（1分も待てば十分）

## 8.3.3 Changing Media Types

- メディアのタイプ変更（オーディオとビデオ）
  - `m=`行の該当部分を書き換えて送る

## 8.3.4 Changing Attributes

- `a=`を変えたい場合
- 上述のいずれかの方法で、メディアを送りなおす

## 8.4 Putting a Unicast Media Stream on Hold

- 通話中に保留したいのようなケース
- `sendrecv`だったものを`sendonly`、`inactive`にする
  - 新しいオファーを送るだけ
- アドレスを`0.0.0.0`にする案があったが非推奨
  - ただし最初のオファーで送信元アドレスが確定してないがオファー発行したい場合などに使えるかも

## 9 Indicating Capabilities

- オファーを発行する前に、アンサー側が受け取れるメディアフォーマットがわかると嬉しい
  - SIPにはそういう機能がある
- そういったやりとりをSDPを使ってやってもいい
  - ただしSDP自体にそういう意味合いは薄い
  - 将来的に拡張されるかもしれない
  - WebRTCでは少なくともやってない

## 10 Example Offer/Answer Exchanges

- オファー・アンサーのSDPの例

## 10.1 Basic Exchange

- AliceとBobが1:1でオファー・アンサー

## 10.2 One of N Codec Selection

- 事前にメディアフォーマットをsyncするパターン

## 11 Security Considerations

- セキュリティの懸念がいくつかある
  - 盗聴
  - 通話の無効化
  - 不要なメディアの挿入など
- オファーとアンサーは暗号化されるべき
  - シグナリング側でMUSTで対応する
- 古いオファー・アンサーのリプレイ攻撃も要対応
  - 順序付けするなどして
- SIPはこれらに対応している

## 12 IANA Considerations

- IANAには関係なし
